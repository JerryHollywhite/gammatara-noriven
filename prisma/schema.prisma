// This is the blueprint for the postgres database.
// location: prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url = env("POSTGRES_PRISMA_URL") // uses connection pooling
  directUrl = env("POSTGRES_URL_NON_POOLING") // uses a direct connection
}

// --- USER MANAGEMENT ---

enum UserRole {
  STUDENT
  TEACHER
  PARENT
  ADMIN
}

enum ScheduleType {
  RECURRING  // Weekly recurring schedule
  ONE_TIME   // Single session
  EXCEPTION  // Override/cancel specific date
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?
  phone         String?
  role          UserRole  @default(STUDENT)
  
  // Relations
  studentProfile     StudentProfile?
  teacherProfile     TeacherProfile?
  parentProfile      ParentProfile?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  createdExams  Exam[]    @relation("ExamCreator")
  forumPosts    ForumPost[]
  forumReplies  ForumReply[]
}

model StudentProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  gradeLevel  String   // "10 (SMA)", "Adult", etc.
  parentId    String?
  parent      ParentProfile? @relation(fields: [parentId], references: [id])
  
  // Gamification
  xp          Int      @default(0)
  level       Int      @default(1)
  streakDays  Int      @default(0)
  
  // Data
  enrollments Enrollment[]
  progress    LessonProgress[]
  submissions AssignmentSubmission[]
  badges      EarnedBadge[]
  
  // Phase 7: Exams & Finance
  examAttempts ExamAttempt[]
  invoices     Invoice[]
}

model TeacherProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  specialty   String?
  
  assignments Assignment[]
  classes     ClassGroup[]
  liveClasses LiveClass[]
}

model ParentProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  children    StudentProfile[]
}

// --- LMS CORE ---

model ClassGroup {
  id          String   @id @default(cuid())
  name        String   // "Algebra II - Morning"
  teacherId   String
  teacher     TeacherProfile @relation(fields: [teacherId], references: [id])
  
  programId   String?  // Link to Program (TK, SD, SMP, etc.)
  program     Program? @relation(fields: [programId], references: [id])

  students    Enrollment[]
  liveClasses LiveClass[]
  exams       Exam[]
  forumPosts  ForumPost[]
  schedules   ClassSchedule[] // Class schedules
  assignments Assignment[]    // Class assignments
}

model Enrollment {
  id          String   @id @default(cuid())
  studentId   String
  student     StudentProfile @relation(fields: [studentId], references: [id])
  
  classId     String?
  class       ClassGroup? @relation(fields: [classId], references: [id])
  
  subjectId   String?  // Link to new Subject model
  subject     Subject? @relation(fields: [subjectId], references: [id])
  
  courseId    String?  // Legacy string ID from Sheets (keep for migration safely)
  status      String   @default("ACTIVE") // ACTIVE, COMPLETED
  
  joinedAt    DateTime @default(now())
}

model LessonProgress {
  id          String   @id @default(cuid())
  studentId   String
  student     StudentProfile @relation(fields: [studentId], references: [id])
  
  lessonId    String
  lesson      Lesson   @relation(fields: [lessonId], references: [id])
  // Previously lessonId was a string ID from sheets, now it's FK to Lesson table.
  
  status      String   @default("NOT_STARTED") // STARTED, COMPLETED
  score       Int?     // For quizzes
  
  completedAt DateTime?
}

// --- ASSESSMENT ---

model Assignment {
  id          String   @id @default(cuid())
  teacherId   String
  teacher     TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  // Link to specific class
  classId     String
  class       ClassGroup @relation(fields: [classId], references: [id], onDelete: Cascade)
  
  title       String
  description String?
  
  // Resource attachment
  attachmentUrl String?  // Google Drive, YouTube, etc.
  
  // Grading configuration
  maxScore    Int @default(100)
  
  dueDate     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  submissions AssignmentSubmission[]
}

// Class Scheduling
model ClassSchedule {
  id          String   @id @default(cuid())
  classId     String
  class       ClassGroup @relation(fields: [classId], references: [id], onDelete: Cascade)
  
  type        ScheduleType @default(RECURRING)
  
  // For RECURRING: day of week (1=Mon, 2=Tue, ..., 7=Sun)
  dayOfWeek   Int?     
  
  // Time (stored as HH:mm format, e.g. "10:00", "14:30")
  startTime   String
  endTime     String
  
  // For ONE_TIME or EXCEPTION: specific date
  date        DateTime?
  
  // For EXCEPTION: reference to recurring schedule being overridden
  overridesId String?
  overrides   ClassSchedule? @relation("ScheduleOverride", fields: [overridesId], references: [id], onDelete: SetNull)
  exceptions  ClassSchedule[] @relation("ScheduleOverride")
  
  // Cancellation flag
  isCancelled Boolean @default(false)
  
  // Audit fields
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AssignmentSubmission {
  id           String   @id @default(cuid())
  assignmentId String
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  
  studentId    String
  student      StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  // Submission content
  contentUrl   String?  // Link to student's work
  contentText  String?  // Text submission
  submittedAt  DateTime @default(now())
  
  // Grading
  grade        Int?
  feedback     String?
  gradedAt     DateTime?  // When graded
}

// --- GAMIFICATION ---

model EarnedBadge {
  id          String   @id @default(cuid())
  studentId   String
  student     StudentProfile @relation(fields: [studentId], references: [id])
  
  badgeCode   String   // "MATH_WHIZ", "WEEKLY_STREAK"
  earnedAt    DateTime @default(now())
}

// --- LIVE CLASSES ---

model LiveClass {
  id          String   @id @default(cuid())
  title       String
  description String?
  teacherId   String
  teacher     TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  classId     String?
  class       ClassGroup? @relation(fields: [classId], references: [id])
  
  zoomLink    String
  meetingId   String?
  passcode    String?
  
  scheduledAt DateTime
  duration    Int      // in minutes
  status      String   @default("SCHEDULED") // SCHEDULED, ONGOING, COMPLETED, CANCELLED
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// --- NEW LMS CONTENT MODELS (Replaces Google Sheets Master DB) ---

model Program {
  id          String    @id @default(cuid())
  code        String    @unique // e.g. "TK", "SD" (was ID in Sheet)
  name        String
  description String?
  active      Boolean   @default(true)
  
  subjects    Subject[]
  classes     ClassGroup[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Subject {
  id          String       @id @default(cuid())
  code        String       @unique // e.g. "MATH_101" (was ID in Sheet)
  name        String
  description String?
  programId   String?
  program     Program?     @relation(fields: [programId], references: [id])
  
  lessons     Lesson[]
  enrollments Enrollment[]
  
  exams       Exam[]
  
  active      Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Lesson {
  id          String    @id @default(cuid())
  title       String
  description String?
  subjectId   String
  subject     Subject   @relation(fields: [subjectId], references: [id])
  
  videoUrl    String?   // YouTube Link
  fileUrl     String?   // Google Drive Link
  
  order       Int       @default(0)
  active      Boolean   @default(true)
  
  quizzes     Quiz[]
  progress    LessonProgress[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  attachments LessonAttachment[]
}

model LessonAttachment {
  id        String   @id @default(cuid())
  lessonId  String
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  name      String
  url       String   // Drive Link or ID
  type      String   // e.g. "application/pdf"
  size      Int?     // Size in bytes
  
  createdAt DateTime @default(now())
}

model Quiz {
  id          String     @id @default(cuid())
  title       String
  lessonId    String
  lesson      Lesson     @relation(fields: [lessonId], references: [id])
  
  questions   Question[]
  
  active      Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model Question {
  id            String   @id @default(cuid())
  quizId        String
  quiz          Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  
  questionText  String
  options       Json     // Array of strings ["A", "B", "C", "D"]
  correctAnswer String   // The correct string value
  points        Int      @default(10)
}


// --- EXAM ENGINE (CBT) ---

model Exam {
  id          String    @id @default(cuid())
  title       String
  description String?
  subjectId   String?
  subject     Subject?   @relation(fields: [subjectId], references: [id])
  
  createdById String?
  createdBy   User?      @relation("ExamCreator", fields: [createdById], references: [id])
  
  classId     String?
  class       ClassGroup? @relation(fields: [classId], references: [id])
  
  durationMinutes Int   @default(60)
  passingGrade    Int   @default(75)
  
  maxAttempts     Int   @default(1)
  active          Boolean @default(true)
  
  startTime       DateTime?
  endTime         DateTime?
  

  
  // questions   Question[] // REMOVED: Using separate ExamQuestion model 
                         // Note: Current Question model is linked to Quiz. 
                         // We might need to make Question polymorphic or just use Quiz for "Exams" too.
                         // For simplicity, let's treat "Quiz" as "Practice" and "Exam" as "Test".
                         // We'll create a new ExamQuestion model or reuse if we refactor.
                         // Let's create ExamQuestion for separation.
  
  examQuestions ExamQuestion[]
  attempts      ExamAttempt[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model ExamQuestion {
  id            String   @id @default(cuid())
  examId        String
  exam          Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  
  questionText  String
  type          String   @default("MCQ") // MCQ, ESSAY, GRID, RATING, SCALE
  options       Json     // ["A", "B", "C", "D"]
  
  // New Fields for Grid / Scale
  rows          Json?    // ["Row 1", "Row 2"]
  cols          Json?    // ["Col 1", "Col 2"]
  scaleMin      Int?
  scaleMax      Int?
  scaleMinLabel String?
  scaleMaxLabel String?

  correctAnswer String
  points        Int      @default(1)
}

model ExamAttempt {
  id          String   @id @default(cuid())
  examId      String
  exam        Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  
  studentId   String
  student     StudentProfile @relation(fields: [studentId], references: [id])
  
  score       Float?
  startedAt   DateTime @default(now())
  completedAt DateTime?
  
  answers     Json?     // Store student answers { "qId": "answer" }
  status      String    @default("IN_PROGRESS") // IN_PROGRESS, COMPLETED
}

// --- FINANCIAL SYSTEM ---

model Invoice {
  id          String   @id @default(cuid())
  studentId   String
  student     StudentProfile @relation(fields: [studentId], references: [id])
  
  title       String   // "SPP January 2025"
  amount      Float
  dueDate     DateTime
  
  status      String   @default("UNPAID") // UNPAID, PENDING, PAID, OVERDUE
  
  payment     Payment?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Payment {
  id          String   @id @default(cuid())
  invoiceId   String   @unique
  invoice     Invoice  @relation(fields: [invoiceId], references: [id])
  
  amountPaid  Float
  method      String   // "MANUAL_TRANSFER"
  proofUrl    String?  // Image of transfer receipt
  
  verifiedBy  String?  // Admin User ID
  verifiedAt  DateTime?
  
  createdAt   DateTime @default(now())
}

// --- FORUM / DISCUSSION ---

model ForumPost {
  id          String   @id @default(cuid())
  classId     String
  class       ClassGroup @relation(fields: [classId], references: [id], onDelete: Cascade)
  
  authorId    String
  author      User     @relation(fields: [authorId], references: [id])
  authorType  String   // "TEACHER" | "STUDENT"
  
  title       String
  content     String   @db.Text
  imageUrl    String?  // Optional image attachment
  
  replies     ForumReply[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ForumReply {
  id          String   @id @default(cuid())
  postId      String
  post        ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  authorId    String
  author      User     @relation(fields: [authorId], references: [id])
  authorType  String   // "TEACHER" | "STUDENT"
  
  content     String   @db.Text
  imageUrl    String?  // Optional image attachment
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

